<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>차량 감가 계산기</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 20px;
      background: #f7f7f7;
    }
    h1 { text-align: center; }
    .container {
      max-width: 800px; margin: auto;
      background: #fff; padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .input-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
    }
    input[type="number"] {
      width: 100%; padding: 8px;
      box-sizing: border-box;
    }
    .checkbox-container {
      position: relative;
      margin: 20px 0;
      height: 400px;
      background-image: url('https://i.imgur.com/JfP4Tde.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }
    .checkbox-item {
      position: absolute;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.8);
      padding: 2px 5px;
      border-radius: 4px;
      font-size: 12px;
    }
    .checkbox-item input[type="checkbox"] {
      margin-right: 3px;
    }
    .checkbox-item.selected {
      background: yellow;
    }
    #repairInputArea {
      display: none;
      margin-bottom: 15px;
    }
    .deduction-total {
      font-weight: bold;
      margin-top: 10px;
    }
    button {
      padding: 10px 15px;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>차량 감가 계산기</h1>
    <div class="input-group">
      <label for="bidPriceInput">입찰가 (원):</label>
      <input type="number" id="bidPriceInput" oninput="saveInput('bidPriceInput'); updateAll();">
    </div>

    <div class="checkbox-container" id="partSection"></div>
    <div class="checkbox-container" id="accidentSection"></div>

    <div class="input-group">
      <label><input type="checkbox" id="needsRepair" onchange="toggleRepairInput()"> 수리요망 있음</label>
    </div>
    <div id="repairInputArea">
      <label for="repairCost">수리 예상 금액 (원):</label>
      <input type="number" id="repairCost" oninput="saveInput('repairCost'); updateAll();">
    </div>

    <div class="input-group">
      <h3>최종 예상 낙찰가: <span id="finalPrice">0</span> 원</h3>
    </div>

    <div id="deductionArea"></div>

    <button onclick="resetAll()">전체 초기화</button>
  </div>

  <script>
    const CONSTANTS = {
      partPrice: 100000,
      wheelPrice: 50000,
      partNames: [
        "앞범퍼", "본넷", "앞휀더좌", "앞휀더우", "앞도어좌",
        "앞도어우", "뒷도어좌", "뒷도어우", "쿼터패널좌", "쿼터패널우",
        "트렁크", "뒷범퍼", "루프", "휠좌", "휠우"
      ],
      accidentParts: [
        { name: "프레임", top: "20%", left: "10%", rate: 10 },
        { name: "사이드멤버좌", top: "30%", left: "20%", rate: 5 },
        { name: "사이드멤버우", top: "30%", left: "80%", rate: 5 },
        { name: "인사이드패널좌", top: "50%", left: "15%", rate: 3 },
        { name: "인사이드패널우", top: "50%", left: "85%", rate: 3 },
        { name: "필러", top: "40%", left: "50%", rate: 3 }
      ]
    };

    function getNumericValue(value) {
      return Number(String(value).replace(/[^0-9.-]+/g, '')) || 0;
    }

    function saveInput(id) {
      const input = document.getElementById(id);
      localStorage.setItem(id, input.type === 'checkbox' ? input.checked : input.value);
    }

    function loadInputs() {
      ['bidPriceInput', 'repairCost'].forEach(id => {
        const input = document.getElementById(id);
        const value = localStorage.getItem(id);
        if (value !== null) input.value = value;
      });
      const needsRepair = localStorage.getItem('needsRepair') === 'true';
      document.getElementById('needsRepair').checked = needsRepair;
      document.getElementById('repairInputArea').style.display = needsRepair ? 'block' : 'none';
    }

    function saveCheckboxState() {
      const states = {};
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        states[cb.dataset.name] = cb.checked;
      });
      localStorage.setItem('checkboxStates', JSON.stringify(states));
    }

    function loadCheckboxState() {
      const saved = JSON.parse(localStorage.getItem('checkboxStates') || '{}');
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        if (cb.dataset.name && saved.hasOwnProperty(cb.dataset.name)) {
          cb.checked = saved[cb.dataset.name];
        }
      });
    }

    function updateAll() {
      const bidPrice = getNumericValue(document.getElementById('bidPriceInput').value);
      let partDiscount = 0, accidentDiscount = 0, repairDiscount = 0;
      const deductionDetails = [];

      document.querySelectorAll(".part").forEach(checkbox => {
        const label = checkbox.parentNode;
        if (checkbox.checked) {
          const name = checkbox.dataset.name;
          const discount = name.includes('휠') ? CONSTANTS.wheelPrice : CONSTANTS.partPrice;
          partDiscount += discount;
          deductionDetails.push(`${name}: -${discount.toLocaleString()}원`);
          label.classList.add('selected');
        } else {
          label.classList.remove('selected');
        }
      });

      document.querySelectorAll(".accident").forEach(checkbox => {
        const label = checkbox.parentNode;
        if (checkbox.checked) {
          const name = checkbox.dataset.name;
          const rate = Number(checkbox.dataset.rate);
          const discount = Math.floor(bidPrice * (rate / 100));
          accidentDiscount += discount;
          deductionDetails.push(`${name} 사고 감가: -${discount.toLocaleString()}원`);
          label.classList.add('selected');
        } else {
          label.classList.remove('selected');
        }
      });

      if (document.getElementById('needsRepair').checked) {
        const repairCost = getNumericValue(document.getElementById('repairCost').value);
        if (repairCost > 0) {
          repairDiscount = repairCost;
          deductionDetails.push(`수리요망 감가: -${repairCost.toLocaleString()}원`);
        }
      }

      const totalDiscount = partDiscount + accidentDiscount + repairDiscount;
      const finalPrice = bidPrice - totalDiscount;
      document.getElementById('finalPrice').textContent = finalPrice.toLocaleString();

      document.getElementById('deductionArea').innerHTML = deductionDetails.length
        ? `<h3>감가 세부내역</h3><ul>${deductionDetails.map(d => `<li>${d}</li>`).join('')}</ul><div class="deduction-total">감가 총합계: -${totalDiscount.toLocaleString()}원</div>`
        : '';

      saveCheckboxState();
    }

    function toggleRepairInput() {
      const needsRepair = document.getElementById('needsRepair').checked;
      document.getElementById('repairInputArea').style.display = needsRepair ? 'block' : 'none';
      saveInput('needsRepair');
      updateAll();
    }

    function resetAll() {
      localStorage.clear();
      document.querySelectorAll("input").forEach(input => {
        if (input.type === 'checkbox') input.checked = false;
        else input.value = '';
      });
      document.getElementById('repairInputArea').style.display = 'none';
      updateAll();
    }

    function createCheckboxes() {
      const partSection = document.getElementById('partSection');
      CONSTANTS.partNames.forEach((name, index) => {
        const label = document.createElement('label');
        label.className = 'checkbox-item';
        label.style.top = `${10 + (index % 5) * 15}%`;
        label.style.left = `${10 + (index % 4) * 20}%`;
        label.innerHTML = `<input type="checkbox" class="part" data-name="${name}" onchange="updateAll()"> ${name}`;
        partSection.appendChild(label);
      });

      const accidentSection = document.getElementById('accidentSection');
      CONSTANTS.accidentParts.forEach(part => {
        const label = document.createElement('label');
        label.className = 'checkbox-item';
        label.style.top = part.top;
        label.style.left = part.left;
        label.innerHTML = `<input type="checkbox" class="accident" data-name="${part.name}" data-rate="${part.rate}" onchange="updateAll()"> ${part.name}`;
        accidentSection.appendChild(label);
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
      createCheckboxes();
      loadInputs();
      loadCheckboxState();
      updateAll();
    });
  </script>
</body>
</html>
